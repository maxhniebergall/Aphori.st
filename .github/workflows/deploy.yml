name: Deploy to Production

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  REGION: us-central1
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PORT: ${{ secrets.DB_PORT }}
  REDIS_HOST: ${{ secrets.REDIS_HOST }}
  REDIS_PORT: ${{ secrets.REDIS_PORT }}
  BATCH_CHECKPOINT_BUCKET: aphorist-batch-ingestion-bucket

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_PAT }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set short SHA
        run: echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      # Build and push all images
      - name: Build and push combined API+DE image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            gcr.io/${{ env.PROJECT_ID }}/chitin-api:${{ env.SHORT_SHA }}
            gcr.io/${{ env.PROJECT_ID }}/chitin-api:latest
          cache-from: type=gha,scope=chitin-api-combined
          cache-to: type=gha,mode=max,scope=chitin-api-combined

      - name: Build and push Web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          tags: |
            gcr.io/${{ env.PROJECT_ID }}/chitin-web:${{ env.SHORT_SHA }}
            gcr.io/${{ env.PROJECT_ID }}/chitin-web:latest
          build-args: |
            NEXT_PUBLIC_API_URL=https://aphori.st
            NEXT_PUBLIC_APP_URL=https://aphori.st
          cache-from: type=gha,scope=chitin-web
          cache-to: type=gha,mode=max,scope=chitin-web

      # Fetch existing service URLs before deploy so all env vars are set from the first revision
      - name: Get existing service URLs
        id: existing-urls
        run: |
          API_URL=$(gcloud run services describe chitin-api \
            --region "$REGION" \
            --format 'value(status.url)')
          echo "api_url=$API_URL" >> "$GITHUB_OUTPUT"

      # Grant the API service account read/write access to the batch checkpoint bucket (idempotent)
      - name: Grant batch bucket access to API service account
        continue-on-error: true
        run: |
          gcloud storage buckets add-iam-policy-binding gs://$BATCH_CHECKPOINT_BUCKET \
            --member="serviceAccount:chitin-api@$PROJECT_ID.iam.gserviceaccount.com" \
            --role="roles/storage.objectUser"

      # Deploy API to Cloud Run (migrations run automatically on startup)
      - name: Deploy API
        run: |
          gcloud run deploy chitin-api \
            --image gcr.io/$PROJECT_ID/chitin-api:$SHORT_SHA \
            --region $REGION \
            --platform managed \
            --port 3001 \
            --memory 1536Mi \
            --cpu-boost \
            --min-instances 0 \
            --max-instances 3 \
            --vpc-connector chitin-vpc \
            --service-account chitin-api@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars "\
          NODE_ENV=production,\
          DB_HOST=$DB_HOST,\
          DB_PORT=$DB_PORT,\
          DB_USER=chitin,\
          DB_NAME=chitin,\
          REDIS_HOST=$REDIS_HOST,\
          REDIS_PORT=$REDIS_PORT,\
          CORS_ORIGINS=https://aphori.st,\
          APP_URL=https://aphori.st,\
          API_URL=${{ steps.existing-urls.outputs.api_url }},\
          SERVICE_AUTH_AUDIENCE=${{ steps.existing-urls.outputs.api_url }},\
          BATCH_CHECKPOINT_BUCKET=$BATCH_CHECKPOINT_BUCKET" \
            --set-secrets "\
          DB_PASSWORD=POSTGRES_PASSWORD:latest,\
          REDIS_PASSWORD=REDIS_PASSWORD:latest,\
          JWT_SECRET=JWT_SECRET:latest,\
          MAGIC_LINK_SECRET=MAGIC_LINK_SECRET:latest,\
          GOOGLE_API_KEY=GEMINI_API_KEY:latest,\
          EMAIL_HOST=EMAIL_HOST:latest,\
          EMAIL_PORT=EMAIL_PORT:latest,\
          EMAIL_USERNAME=EMAIL_USERNAME:latest,\
          EMAIL_PASSWORD=EMAIL_PASSWORD:latest,\
          EMAIL_FROM=EMAIL_USERNAME:latest,\
          SYSTEM_ACCOUNT_SECRET=SYSTEM_ACCOUNT_SECRET:latest,\
          SERVICE_AUTH_ALLOWLIST_SECRET=SERVICE_AUTH_ALLOWLIST_SECRET:latest,\
          INTERNAL_API_SECRET=INTERNAL_API_SECRET:latest" \
            --allow-unauthenticated

      # Deploy Web to Cloud Run
      - name: Deploy Web
        run: |
          gcloud run deploy chitin-web \
            --image gcr.io/$PROJECT_ID/chitin-web:$SHORT_SHA \
            --region $REGION \
            --platform managed \
            --port 3000 \
            --memory 256Mi \
            --min-instances 0 \
            --max-instances 3 \
            --service-account chitin-web@$PROJECT_ID.iam.gserviceaccount.com \
            --set-secrets "\
          INTERNAL_API_SECRET=INTERNAL_API_SECRET:latest" \
            --allow-unauthenticated

      # Verify deployment
      - name: Verify health
        run: |
          echo "Checking API health..."
          API_URL=$(gcloud run services describe chitin-api --region $REGION --format 'value(status.url)')
          curl -sf "$API_URL/health" || echo "WARNING: API health check failed"

          echo "Checking Web health..."
          WEB_URL=$(gcloud run services describe chitin-web --region $REGION --format 'value(status.url)')
          curl -sf "$WEB_URL" -o /dev/null || echo "WARNING: Web health check failed"

