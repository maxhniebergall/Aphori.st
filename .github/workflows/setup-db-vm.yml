name: Manage DB VM

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'start'
        type: choice
        options:
          - setup
          - start
          - stop
          - status

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  ZONE: us-central1-a
  VM_NAME: chitin-db
  DB_PORT: ${{ secrets.DB_PORT }}
  REDIS_PORT: ${{ secrets.REDIS_PORT }}

jobs:
  manage-db-vm:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # First-time setup: copy files to VM, configure networking, create data directories
      - name: Setup VM
        if: inputs.action == 'setup'
        run: |
          # Ensure VM has network tag for firewall targeting
          gcloud compute instances add-tags $VM_NAME \
            --zone $ZONE \
            --tags postgres-server

          # Allow Cloud Run (via VPC connector 10.8.0.0/28) to reach DB and Redis
          gcloud compute firewall-rules create allow-cloudrun-to-postgres \
            --network default \
            --allow tcp:$DB_PORT,tcp:$REDIS_PORT \
            --source-ranges 10.8.0.0/28 \
            --target-tags postgres-server \
            --description "Allow Cloud Run via VPC connector to reach DB and Redis" \
          || echo "Firewall rule already exists, skipping."

          gcloud compute scp \
            infra/start-db.sh \
            $VM_NAME:~ \
            --zone $ZONE

          gcloud compute scp --recurse \
            infra/init \
            $VM_NAME:~ \
            --zone $ZONE

          gcloud compute ssh $VM_NAME --zone $ZONE --command "
            sudo mkdir -p /mnt/stateful_partition/chitin/postgres /mnt/stateful_partition/chitin/redis /home/chitin-db
            sudo cp -r ~/init /home/chitin-db/init
            sudo cp ~/start-db.sh /home/chitin-db/start-db.sh
            sudo chmod +x /home/chitin-db/start-db.sh
            echo 'Setup complete.'
          "

      # Start: VM fetches its own secrets from Secret Manager
      - name: Start services
        if: inputs.action == 'start' || inputs.action == 'setup'
        run: |
          gcloud compute ssh $VM_NAME --zone $ZONE --command "
            sudo bash /home/chitin-db/start-db.sh $DB_PORT $REDIS_PORT
          "

      - name: Stop services
        if: inputs.action == 'stop'
        run: |
          gcloud compute ssh $VM_NAME --zone $ZONE --command "
            sudo docker stop chitin-postgres chitin-redis 2>/dev/null || true
            sudo docker rm chitin-postgres chitin-redis 2>/dev/null || true
          "

      - name: Show status
        if: inputs.action == 'status'
        run: |
          gcloud compute ssh $VM_NAME --zone $ZONE --command "
            sudo docker ps --filter name=chitin-
            echo ''
            echo 'Disk usage:'
            df -h /mnt/stateful_partition 2>/dev/null || df -h /
          "
