schema: '2.0'
stages:
  select_themes:
    cmd: python pipeline/theme_selector.py
    deps:
    - path: ../data/categories/wiki_categories_filtered
      hash: md5
      md5: a0524ed4af03780d38e452acd528ce67
      size: 3147
    - path: pipeline/theme_selector.py
      hash: md5
      md5: a43600531a580e543a329424fd13ad40
      size: 5816
    params:
      params.yaml:
        paths:
          themes: data/themes/
          candidates: data/candidates/
          embeddings: data/embeddings/
          outputs: data/outputs/
          reports: reports/
          cache: data/cache/
        puzzle_generation:
          total_puzzle_count: 80
          words_per_theme: 4
          themes_per_puzzle: 4
          candidate_words_per_theme: 50
          min_similarity_threshold: 0.3
          theme_selection_method: random
          random_seed: 42
        themes:
          source: ../data/categories/wiki_categories_filtered
          exclude_categories:
          - General reference
          - Research
          - Academic disciplines
          - Library science
          min_theme_length: 3
    outs:
    - path: data/themes/selected_themes.json
      hash: md5
      md5: 89939b35836595e537679cb999490e40
      size: 5648
  select_candidates:
    cmd: python pipeline/word_selector.py
    deps:
    - path: ../../themes_index/themes_metadata.json
      hash: md5
      md5: 0057523c15907dfe46ab51aac78b3b9a
      size: 148
    - path: ../../themes_index/themes_vectors.bin
      hash: md5
      md5: 4b3ccfe9e1ce0c8d1e099c86142e6484
      size: 1028004008
    - path: ../../themes_index/themes_vocabulary.json
      hash: md5
      md5: d1749de07cefb80a52f7e4db20afee80
      size: 9671670
    - path: data/themes/selected_themes.json
      hash: md5
      md5: 89939b35836595e537679cb999490e40
      size: 5648
    - path: pipeline/word_selector.py
      hash: md5
      md5: fce17c7cf0a342cfc4f3de2d00ae8137
      size: 8668
    params:
      params.yaml:
        paths:
          themes: data/themes/
          candidates: data/candidates/
          embeddings: data/embeddings/
          outputs: data/outputs/
          reports: reports/
          cache: data/cache/
        puzzle_generation:
          total_puzzle_count: 80
          words_per_theme: 4
          themes_per_puzzle: 4
          candidate_words_per_theme: 50
          min_similarity_threshold: 0.3
          theme_selection_method: random
          random_seed: 42
        vector_search:
          data_source: ../../themes_index
          use_lemmatized: true
          similarity_metric: cosine
          max_search_candidates: 50
    outs:
    - path: data/candidates/candidate_words.json
      hash: md5
      md5: 0a92d6b86fe316d227305e2cfc0c4879
      size: 800445
  enhance_with_gemini:
    cmd: python pipeline/gemini_enhancer.py
    deps:
    - path: data/candidates/candidate_words.json
      hash: md5
      md5: 0a92d6b86fe316d227305e2cfc0c4879
      size: 800445
    - path: data/themes/selected_themes.json
      hash: md5
      md5: 89939b35836595e537679cb999490e40
      size: 5648
    - path: pipeline/gemini_enhancer.py
      hash: md5
      md5: 37ff957073af478880df08fe9fbf7c12
      size: 42599
    params:
      params.yaml:
        gemini:
          model_id: gemini-embedding-001
          embedding_dimension: 3072
          api_key_env: GEMINI_API_KEY
          task_type: SEMANTIC_SIMILARITY
          requests_per_minute: 2900
          min_request_interval: 0.1
          retry_base_delay: 1.0
          max_retries: 3
        output:
          format: json
          include_metadata: true
          include_similarity_scores: true
          csv_precision: 6
          embedding_cache_file: data/cache/all_embeddings.csv
          puzzle_embeddings_file: data/embeddings/puzzle_embeddings.csv
        paths:
          themes: data/themes/
          candidates: data/candidates/
          embeddings: data/embeddings/
          outputs: data/outputs/
          reports: reports/
          cache: data/cache/
        puzzle_generation:
          total_puzzle_count: 80
          words_per_theme: 4
          themes_per_puzzle: 4
          candidate_words_per_theme: 50
          min_similarity_threshold: 0.3
          theme_selection_method: random
          random_seed: 42
    outs:
    - path: data/cache/all_embeddings.csv
      hash: md5
      md5: ce2d0f237b744be5b9b8b14ae9865759
      size: 322288728
    - path: data/embeddings/puzzle_embeddings.csv
      hash: md5
      md5: 8d2385cba945e66ec5af25ef3e48d6f5
      size: 46252490
    - path: data/outputs/final_puzzles.json
      hash: md5
      md5: 91858caa793e6cdf52c8a6e2089e218e
      size: 108887
    - path: data/outputs/puzzle_metadata.json
      hash: md5
      md5: 40e8ba3babef8d214acf6d2d1beca16f
      size: 1231
    - path: reports/embedding_analysis.json
      hash: md5
      md5: 37ebbc5c238842752d9521b2e097822d
      size: 620
  convert_to_firebase:
    cmd: node ../../../puzzle-generation/dist/use-gemini-output.js
    deps:
    - path: ../../../puzzle-generation/dist/data-science-bridge.js
      hash: md5
      md5: b7673a42d89c2ec9d19f49da9d6cc678
      size: 15946
    - path: ../../../puzzle-generation/dist/use-gemini-output.js
      hash: md5
      md5: 5571a47d65f7a83cce5f1a5ceb75cca1
      size: 3178
    - path: data/outputs/final_puzzles.json
      hash: md5
      md5: 91858caa793e6cdf52c8a6e2089e218e
      size: 108887
    outs:
    - path: data/outputs/gemini-puzzles.json
      hash: md5
      md5: bb1b8bd9e292571e98704e9ba94b4a94
      size: 214071
    - path: data/outputs/gemini-puzzles_firebase.json
      hash: md5
      md5: b3f1e65f1094ee34ff30ceb1d5aab69d
      size: 190842
  copy_to_puzzle_generation:
    cmd: cp data/outputs/gemini-puzzles.json ../../../puzzle-generation/ && cp 
      data/outputs/gemini-puzzles_firebase.json ../../../puzzle-generation/
    deps:
    - path: data/outputs/gemini-puzzles.json
      hash: md5
      md5: bb1b8bd9e292571e98704e9ba94b4a94
      size: 214071
    - path: data/outputs/gemini-puzzles_firebase.json
      hash: md5
      md5: b3f1e65f1094ee34ff30ceb1d5aab69d
      size: 190842
